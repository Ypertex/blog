<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>How to Advertise Subnets to Upstream Routers with OPNsense and ARP · Ypertex Blog</title>
    
    <meta name="description" content="Design. Technology. Future.">
    <meta name="generator" content="Hugo 0.62.2" />
    <link rel="shortcut icon" href="/favicon.ico">
    
    <link rel="stylesheet" type="text/css" href="/inhabitu-scss/inhabitu.css">
    <meta property="og:url" content="https://blog.ypertex.com/articles/advertise-subnet-with-opnsense-arp/" />
    <meta property="og:title" content="How to Advertise Subnets to Upstream Routers with OPNsense and ARP · Ypertex Blog" />
    

<meta property="og:description" content="If you ever wondered how to split a subnet away from a fixed upstream gateway, here’s how you can achieve this with ARP in OPNsense." />

<meta property="og:image" content="https://blog.ypertex.com/media/split-rock.jpg" />

    <meta name="twitter:card" content="summary_large_image" />
    
    <meta name="twitter:site" content="@Ypertex" />
    
    <meta name="twitter:creator" content="@MichaelSchmidle" />
</head>

<body>
    <header class="hero is-primary">
        <div class="hero-head">
            <nav class="navbar">
                <div class="container">
                    <div class="navbar-brand">
                        <a href="/"
                            class="navbar-item"><img
                                class="inhabitu-navbar-logo" src="/media/logos/ypertex-logo-2017-01-inverted.png">
                            Ypertex Blog</a>
                        <a class="navbar-burger" data-target="menu"><span></span><span></span><span></span></a>
                    </div>
                    <div class="navbar-menu" id="menu">
                        <div class="navbar-end">
                            
                            <a class="navbar-item is-active"
                                href="/articles/">Articles</a>
                            <a class="navbar-item"
                                href="/tags/">Tags</a>
                            <a class="navbar-item"
                                href="/authors/">Authors</a>
                            <a class="navbar-item" href="https://twitter.com/Ypertex"
                                title="Twitter"><i class="inhabitu-twitter icon"></i><span class="is-hidden-tablet">
                                    Twitter</span></a>
                            <a class="navbar-item" href="https://github.com/Ypertex/blog"
                                title="GitHub"><i class="inhabitu-github icon"></i><span class="is-hidden-tablet">
                                    GitHub</span></a>
                        </div>
                    </div>
                </div>
            </nav>
        </div>
        <div class="hero-body">
            <div class="container has-text-centered">
                
<h1 class="title is-1">How to Advertise Subnets to Upstream Routers With OPNsense and ARP</h1>

            </div>
        </div>
    </header>
    <main>
        
<section class="section">
    <div class="content container">
        <p class="is-size-5">If you ever wondered how to split a subnet away from a fixed upstream gateway, here’s how you can achieve this with ARP in OPNsense.</p>
<div class="level is-tablet">
    <div class="level-left">
        <div class="media level-item">
            
            
            
            
            
            <div class="media-left image is-32x32">
                <img class="inhabitu-author"
                    src="https://res.cloudinary.com/ypertex/image/upload/c_thumb,dpr_2,g_face,h_32,q_auto,w_32/v1574196471/people/michael-schmidle.jpg">
            </div>
            
            
            
            <small class="media-content">
                
                <strong><a href="/authors/michael-schmidle/">Michael Schmidle</a></strong>
                
                <time class="heading"
                    datetime="2018-08-02">August 2, 2018</time>
            </small>
        </div>
    </div>
    
    <div class="level-right">
        
        <a class="level-item tag is-rounded" href="/tags/tutorials"><span class="icon"><i
                    class="inhabitu-tag"></i></span> Tutorials</a>
        
    </div>
    
</div>
<figure>
    <img src="https://res.cloudinary.com/ypertex/image/upload/ar_5:3,c_fill,g_auto,q_auto,w_740/v1574344649/a6e46127-e43f-4ea3-9aa8-819893c0f602.jpg">
    <figcaption>Splitting stuff is hard enough, but how do you move away the part that you just split off? (Image: <a href="https://unsplash.com/photos/an3qaxZ-2bY">Pablo Heimplatz</a>)</figcaption>
</figure>
<p>Today was the first time that I needed to split one IPv4 subnet into two and forward the second half to somewhere else—without the ability to configure the upstream gateway. It took me a while to figure out how to achieve this with an <a href="https://opnsense.org/">OPNsense firewall</a> as my router. I thought I’d document this in case anyone else is looking for a solution to this, too.</p>
<h2 id="the-challenge-of-transparently-splitting-a-subnet">The Challenge of Transparently Splitting a Subnet</h2>
<p>Consider the following scenario: My <abbr title="Internet Service Provider">ISP</abbr> allocated me a <code>/28</code> subnet (<code>x.x.129.208/28</code>). Along with it, they provided a gateway on the first IP of the subnet (<code>x.x.129.209</code>) and nothing else—and that was the problem.</p>
<p>Usually when you are provided a subnet, it is routed to the fixed public IP of your router. This IP is not part of the subnet so you have the freedom to forward the routing of the subnet downstream over any number of hops to anywhere you need it in your infrastructure. In this case however, the first IP was assigned to the ISP gateway—making it impossible to allocate the subnet somewhere else. My router had to be in the exact same subnet (i.e. <code>x.x.129.210</code>).</p>
<figure>
    <img src="/media/advertise-subnet-with-opnsense-arp-1.png">
    <figcaption>Schema of network conditions dictated by my ISP.</figcaption>
</figure>
<p>However, what I wanted was a <abbr title="Demilitarized Zone">DMZ</abbr> <em>behind that firewall router</em>, i.e. servers that are accessible via public IPs without <abbr title="Network Address Translation">NAT</abbr> or Transparent Bridging. So I split the <code>/28</code> subnet in two <code>/29</code>:</p>
<ul>
<li><code>x.x.129.208/29</code></li>
<li><code>x.x.129.216/29</code></li>
</ul>
<p>This is how it looked once configured on the firewall router and DMZ:</p>
<figure>
    <img src="/media/advertise-subnet-with-opnsense-arp-2.png">
    <figcaption>Schema of the networks as I wanted to route them.</figcaption>
</figure>
<p>Notice how the firewall router has the same Internet-facing IP but with a different netmask now?</p>
<p>I thought that the OPNsense firewall router would be intelligent enough to advertise to the upstream ISP gateway, that the IP <code>x.x.129.210</code> and all IPs <code>x.x.129.116</code>-<code>.123</code> of the <code>/29</code> DMZ subnet were all to be routed via its ISP-facing IP (<code>x.x.129.210</code>).</p>
<p>But no, it doesn’t work like this out of the box. And there was no way for me to explicitly configure the ISP gateway to route the <code>/29</code> DMZ subnet to a specific IP.</p>
<h2 id="the-solution-proxy-arp">The Solution: Proxy ARP</h2>
<p>After lots of DuckDuckGoing (If searching with Google is called Googling, then that’s what searching with <a href="https://duckduckgo.com">DuckDuckGo</a> must be called, right?) to no avail, I finally stumbled over the <em>Virtual IP</em> settings in OPNsense, specifically of type <em>Proxy <abbr title="Address Resolution Protocol">ARP</title></em>.</p>
<p>This Proxy ARP type of virtual IP allows you to broadcast the advertisement of IPs or subnets via an interface. So I entered:</p>
<ul>
<li>Mode: Proxy ARP</li>
<li>Interface: WAN</li>
<li>Address: <code>x.x.129.216/29</code></li>
</ul>
<figure>
    <img src="/media/opnsense-virtual-ip-proxy-arp.png">
    <figcaption>Setting Proxy ARP virtual IPs in OPNsense.</figcaption>
</figure>
<p>In other words: The OPNsense firewall router now published to the ISP gateway that (besides the IP <code>x.x.129.210</code>) it also was the recipient for all IP packets of the <code>/29</code> DMZ subnet. In a way, ARP allows to configure upstream routers that are not part of your own infrastructure.</p>
<p>This works like a charm. Servers in the DMZ configured with the public IPs of the second <code>/29</code> subnet are now able to communicate in both directions with the Internet.</p>
<hr>

<div class="message is-info inhabitu-overflow-top inhabitu-overflow-bottom">
    <h6 class="message-header">Note<i class="inhabitu-info icon"></i>
    </h6>
    <div class="message-body">
        OPNsense automatically adds the DMZ subnet to its NAT, so don’t forget to remove it manually. In this case, it was translating the public subnet <code>x.x.129.216/29</code> to the public IP <code>x.x.129.210</code>—which of course doesn’t make any sense whatsoever. It might work in the outbound direction, but your DMZ can’t be reached from the outside, rendering the DMZ useless.
    </div>
</div>



    </div>
</section>
<section class="inhabitu-emphasize section">
    <div class="container">
        <span class="heading">Share this article</span>
        <div class="inhabitu-overflow box">
            <div class="level is-mobile">
                <div class="level-item">
                    <a class="tag icon is-large is-primary is-rounded"
                        href="https://twitter.com/intent/tweet?text=How%20to%20Advertise%20Subnets%20to%20Upstream%20Routers%20with%20OPNsense%20and%20ARP&amp;url=https%3a%2f%2fblog.ypertex.com%2farticles%2fadvertise-subnet-with-opnsense-arp%2f"
                        title="Twitter"
                        onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;"><i
                            class="inhabitu-twitter"></i></a>
                </div>
                <div class="level-item">
                    <a class="tag icon is-large is-primary is-rounded"
                        href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fblog.ypertex.com%2farticles%2fadvertise-subnet-with-opnsense-arp%2f&amp;title=How%20to%20Advertise%20Subnets%20to%20Upstream%20Routers%20with%20OPNsense%20and%20ARP&amp;source=Ypertex%20Blog"
                        title="LinkedIn"
                        onclick="window.open(this.href, 'linkedin-share', 'width=490,height=530');return false;"><i
                            class="inhabitu-linkedin"></i></a>
                </div>
                <div class="level-item">
                    <a class="tag icon is-large is-primary is-rounded"
                        href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.ypertex.com%2farticles%2fadvertise-subnet-with-opnsense-arp%2f" title="Facebook"
                        onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;"><i
                            class="inhabitu-facebook"></i></a>
                </div>
            </div>
        </div>
    </div>
</section>

<section class="section">
    <div class="content container">
        
        <span class="heading">Next article</span>
        <article>
    <h1 class="title is-3"><a href="/articles/tools-for-the-smart-start-up-in-2018-2/">Tools for the Smart Start-Up in 2018 (II)</a></h1>
    <p class="content">Small budgets can get you great IT infrastructure. Running great desktop and web applications on top can be very inexpensive, too. Here’s how. <small class="is-size-7"><strong><a
                    href="/articles/tools-for-the-smart-start-up-in-2018-2/">Continue&nbsp;reading</a></strong></small></p>
    <div class="level is-tablet">
    <div class="level-left">
        <div class="media level-item">
            
            
            
            
            
            <div class="media-left image is-32x32">
                <img class="inhabitu-author"
                    src="https://res.cloudinary.com/ypertex/image/upload/c_thumb,dpr_2,g_face,h_32,q_auto,w_32/v1574196471/people/michael-schmidle.jpg">
            </div>
            
            
            
            <small class="media-content">
                
                <strong><a href="/authors/michael-schmidle/">Michael Schmidle</a></strong>
                
                <time class="heading"
                    datetime="2018-11-07">November 7, 2018</time>
            </small>
        </div>
    </div>
    
    <div class="level-right">
        
        <a class="level-item tag is-rounded" href="/tags/it-recommendations"><span class="icon"><i
                    class="inhabitu-tag"></i></span> IT Recommendations</a>
        
    </div>
    
</div>
</article>
        
        
        <hr>
        
        
        <span class="heading">Previous article</span>
        <article>
    <h1 class="title is-3"><a href="/articles/tools-for-the-smart-start-up-in-2018-1/">Tools for the Smart Start-Up in 2018 (I)</a></h1>
    <p class="content">If you start a project on a small budget today in 2018, there is no need to do without state-of-the-art IT infrastructure for your team. Let me give you some ideas. [Updated June 28, 2019] <small class="is-size-7"><strong><a
                    href="/articles/tools-for-the-smart-start-up-in-2018-1/">Continue&nbsp;reading</a></strong></small></p>
    <div class="level is-tablet">
    <div class="level-left">
        <div class="media level-item">
            
            
            
            
            
            <div class="media-left image is-32x32">
                <img class="inhabitu-author"
                    src="https://res.cloudinary.com/ypertex/image/upload/c_thumb,dpr_2,g_face,h_32,q_auto,w_32/v1574196471/people/michael-schmidle.jpg">
            </div>
            
            
            
            <small class="media-content">
                
                <strong><a href="/authors/michael-schmidle/">Michael Schmidle</a></strong>
                
                <time class="heading"
                    datetime="2018-08-02">August 2, 2018</time>
            </small>
        </div>
    </div>
    
    <div class="level-right">
        
        <a class="level-item tag is-rounded" href="/tags/it-recommendations"><span class="icon"><i
                    class="inhabitu-tag"></i></span> IT Recommendations</a>
        
    </div>
    
</div>
</article>
        
    </div>
</section>


    </main>
    <footer class="footer">
        <div class="content container has-text-centered">
            <div class="columns is-centered">
                
                <div class="column is-narrow">
                    <a href="https://twitter.com/Ypertex"><i class="inhabitu-twitter icon"></i> Twitter</a>
                </div>
                
                
                <div class="column is-narrow">
                    <a href="https://github.com/Ypertex/blog"><i class="inhabitu-github icon"></i> GitHub</a>
                </div>
                
                <div class="column is-narrow">
                    <a href="/index.xml" title="RSS"><i class="inhabitu-rss icon"></i> RSS</a>
                </div>
            </div>
            <p class="is-size-7"><a href="/privacy/">Privacy Policy</a></p>
            <p class="is-size-7">Copyright © 2017-2020 <a
                    href="/">Ypertex Blog</a> ·
                Some rights reserved<br>
                Original content released under the <a
                    href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License (CC BY 4.0)</a>
            </p>
        </div>
    </footer>
    <script type="text/javascript" src="/inhabitu.js"></script>
</body>

</html>