<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=stylesheet href=/ypertex.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Montserrat+Alternates:700,700i|Montserrat:400,400i,700,700i&display=swap"><link rel=stylesheet href=https://maxst.icons8.com/vue-static/landings/line-awesome/line-awesome/1.3.0/css/line-awesome.min.css><title>How to Advertise Subnets to Upstream Routers with OPNsense and ARP · Ypertex Blog</title><link rel=apple-touch-icon sizes=57x57 href=/apple-touch-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=/apple-touch-icon-60x60.png><link rel=apple-touch-icon sizes=72x72 href=/apple-touch-icon-72x72.png><link rel=apple-touch-icon sizes=76x76 href=/apple-touch-icon-76x76.png><link rel=apple-touch-icon sizes=114x114 href=/apple-touch-icon-114x114.png><link rel=apple-touch-icon sizes=120x120 href=/apple-touch-icon-120x120.png><link rel=apple-touch-icon sizes=144x144 href=/apple-touch-icon-144x144.png><link rel=apple-touch-icon sizes=152x152 href=/apple-touch-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon-180x180.png><link rel=icon type=image/png href=/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicon-96x96.png sizes=96x96><link rel=icon type=image/png href=/android-chrome-192x192.png sizes=192x192><meta name=msapplication-square70x70logo content="/smalltile.png"><meta name=msapplication-square150x150logo content="/mediumtile.png"><meta name=msapplication-wide310x150logo content="/widetile.png"><meta name=msapplication-square310x310logo content="/largetile.png"></head><body><header><nav class="navbar navbar-dark navbar-expand-md bg-dark"><div class=container><a class=navbar-brand href=/><svg viewBox="0 0 440 176" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;max-height:1rem"><g transform="matrix(1,0,0,1,-2574,-792)"><g id="Unprotected-primary-color-logogram-on-transparent-background" serif:id="Unprotected primary color logogram on transparent background" transform="matrix(1.12719,0,0,0.885774,2612.5,797.543)"><rect x="-34.159" y="-6.258" width="390.352" height="198.696" style="fill:none"/><clipPath id="_clip1"><rect x="-34.159" y="-6.258" width="390.352" height="198.696"/></clipPath><g clip-path="url(#_clip1)"><g transform="matrix(3.69565,0,0,4.16217,-240.2,-272.956)"><g transform="matrix(0.105625,-6.62507e-18,5.86335e-18,0.119347,45.1899,52.1434)"><path d="M1e2 5e2 3e2 3e2 1e2 1e2h67.274C252.258 1e2 333.761 133.757 393.857 193.846 397.723 197.712 4e2 199.988 4e2 199.988L5e2 99.976 699.976 1e2 8e2 200.024 9e2 1e2h2e2L9e2 3e2l2e2 2e2H1032.74C947.747 5e2 866.238 466.238 806.141 406.141 802.276 402.276 8e2 4e2 8e2 4e2L7e2 5e2H5e2L7e2 3e2 6e2 200.024 3e2 5e2H1e2z" style="fill:#0af"/></g><g transform="matrix(0.105625,0,0,0.119347,45.1899,40.2116)"><path d="M5e2 599.976l4e2-4e2L7e2 199.953 3e2 599.976H5e2z" style="fill:#0e1112;fill-opacity:.2"/></g></g></g></g></g></svg></a><div class="navbar-collapse collapse"><div class="navbar-nav mr-auto"><a href=/articles/ class="nav-item nav-link active">Articles</a>
<a href=/series/ class="nav-item nav-link">Series</a>
<a href=/tags/ class="nav-item nav-link">Tags</a></div><div class=navbar-nav><a href=https://www.linkedin.com/in/michaelschmidle class="nav-item nav-link" title=LinkedIn><i class="lab la-linkedin-in"></i></a><a href=https://twitter.com/MichaelSchmidle/ class="nav-item nav-link" title=Twitter><i class="lab la-twitter"></i></a><a href=https://github.com/MichaelSchmidle/ class="nav-item nav-link" title=GitHub><i class="lab la-github"></i></a></div></div></div></nav></header><main><section class="jumbotron jumbotron-fluid"><div class=container><h1 class=display-4>How to Advertise Subnets to Upstream Routers with OPNsense and ARP</h1><p class="text-muted mb-2"><small><i class="las la-upload"></i>&nbsp;Aug 2, 2018 · <i class="las la-stopwatch"></i>&nbsp;3min read</small></p><p class=mb-0><a href=/tags/tutorials/ class="badge badge-primary"><i class="las la-hashtag"></i>Tutorials</a></p></div></section><section class="yx-content container py-5"><div class=row><div class="col-xl-8 col-lg-10 mx-auto"><p class=lead>If you ever wondered how to split a subnet away from a fixed upstream gateway, here’s how you can achieve this with ARP in OPNsense.</p><hr><p>Today was the first time that I needed to split one IPv4 subnet into two and forward the second half to somewhere else—without the ability to configure the upstream gateway. It took me a while to figure out how to achieve this with an <a href=https://opnsense.org/>OPNsense firewall</a> as my router. I thought I’d document this in case anyone else is looking for a solution to this, too.</p><figure><picture>
<source media="(min-width: 1200px)" srcset=https://res.cloudinary.com/ypertex/image/upload/ar_1.67,c_fill,dpr_auto,f_auto,g_auto,q_auto,w_1140/a6e46127-e43f-4ea3-9aa8-819893c0f602><source media="(min-width: 992px)" srcset=https://res.cloudinary.com/ypertex/image/upload/ar_1.67,c_fill,dpr_auto,f_auto,g_auto,q_auto,w_960/a6e46127-e43f-4ea3-9aa8-819893c0f602><source media="(min-width: 768px)" srcset=https://res.cloudinary.com/ypertex/image/upload/ar_1.67,c_fill,dpr_auto,f_auto,g_auto,q_auto,w_720/a6e46127-e43f-4ea3-9aa8-819893c0f602><source media="(min-width: 576px)" srcset=https://res.cloudinary.com/ypertex/image/upload/ar_1.67,c_fill,dpr_auto,f_auto,g_auto,q_auto,w_767/a6e46127-e43f-4ea3-9aa8-819893c0f602><img src=https://res.cloudinary.com/ypertex/image/upload/ar_1.67,c_fill,dpr_auto,f_auto,g_auto,q_auto,w_575/a6e46127-e43f-4ea3-9aa8-819893c0f602 alt class="shadow img-fluid"></picture><figcaption class="mt-3 col-md-8 mx-auto">Splitting stuff is hard enough, but how do you move away the part that you just split off? <span class=text-muted>[Image:
<a href=https://unsplash.com/photos/an3qaxZ-2bY>Pablo Heimplatz</a>]</span></figcaption></figure><h2 id=the-challenge-of-transparently-splitting-a-subnet>The Challenge of Transparently Splitting a Subnet&nbsp;<a class=yx-anchor href=#the-challenge-of-transparently-splitting-a-subnet><i class="las la-link"></i></a></h2><p>Consider the following scenario: My ISP allocated me a <code>/28</code> subnet (<code>x.x.129.208/28</code>). Along with it, they provided a gateway on the first IP of the subnet (<code>x.x.129.209</code>) and nothing else—and that was the problem.</p><p>Usually when you are provided a subnet, it is routed to the fixed public IP of your router. This IP is not part of the subnet so you have the freedom to forward the routing of the subnet downstream over any number of hops to anywhere you need it in your infrastructure. In this case however, the first IP was assigned to the ISP gateway—making it impossible to allocate the subnet somewhere else. My router had to be in the exact same subnet (i.e. <code>x.x.129.210</code>).</p><figure><picture>
<source media="(min-width: 1200px)" srcset=https://res.cloudinary.com/ypertex/image/upload/ar_1.67,c_fill,dpr_auto,f_auto,g_auto,q_auto,w_1140//media/advertise-subnet-with-opnsense-arp-1.png><source media="(min-width: 992px)" srcset=https://res.cloudinary.com/ypertex/image/upload/ar_1.67,c_fill,dpr_auto,f_auto,g_auto,q_auto,w_960//media/advertise-subnet-with-opnsense-arp-1.png><source media="(min-width: 768px)" srcset=https://res.cloudinary.com/ypertex/image/upload/ar_1.67,c_fill,dpr_auto,f_auto,g_auto,q_auto,w_720//media/advertise-subnet-with-opnsense-arp-1.png><source media="(min-width: 576px)" srcset=https://res.cloudinary.com/ypertex/image/upload/ar_1.67,c_fill,dpr_auto,f_auto,g_auto,q_auto,w_767//media/advertise-subnet-with-opnsense-arp-1.png><img src=https://res.cloudinary.com/ypertex/image/upload/ar_1.67,c_fill,dpr_auto,f_auto,g_auto,q_auto,w_575//media/advertise-subnet-with-opnsense-arp-1.png alt class="shadow img-fluid"></picture><figcaption class="mt-3 col-md-8 mx-auto">Schema of network conditions dictated by my ISP.</figcaption></figure><p>However, what I wanted was a DMZ <em>behind that firewall router</em>, i.e. servers that are accessible via public IPs without NAT or Transparent Bridging. So I split the <code>/28</code> subnet in two <code>/29</code>:</p><ul><li><code>x.x.129.208/29</code></li><li><code>x.x.129.216/29</code></li></ul><p>This is how it looked once configured on the firewall router and DMZ:</p><figure><picture>
<source media="(min-width: 1200px)" srcset=https://res.cloudinary.com/ypertex/image/upload/ar_1.67,c_fill,dpr_auto,f_auto,g_auto,q_auto,w_1140//media/advertise-subnet-with-opnsense-arp-2.png><source media="(min-width: 992px)" srcset=https://res.cloudinary.com/ypertex/image/upload/ar_1.67,c_fill,dpr_auto,f_auto,g_auto,q_auto,w_960//media/advertise-subnet-with-opnsense-arp-2.png><source media="(min-width: 768px)" srcset=https://res.cloudinary.com/ypertex/image/upload/ar_1.67,c_fill,dpr_auto,f_auto,g_auto,q_auto,w_720//media/advertise-subnet-with-opnsense-arp-2.png><source media="(min-width: 576px)" srcset=https://res.cloudinary.com/ypertex/image/upload/ar_1.67,c_fill,dpr_auto,f_auto,g_auto,q_auto,w_767//media/advertise-subnet-with-opnsense-arp-2.png><img src=https://res.cloudinary.com/ypertex/image/upload/ar_1.67,c_fill,dpr_auto,f_auto,g_auto,q_auto,w_575//media/advertise-subnet-with-opnsense-arp-2.png alt class="shadow img-fluid"></picture><figcaption class="mt-3 col-md-8 mx-auto">Schema of the networks as I wanted to route them.</figcaption></figure><p>Notice how the firewall router has the same Internet-facing IP but with a different netmask now?</p><p>I thought that the OPNsense firewall router would be intelligent enough to advertise to the upstream ISP gateway, that the IP <code>x.x.129.210</code> and all IPs <code>x.x.129.116</code>-<code>.123</code> of the <code>/29</code> DMZ subnet were all to be routed via its ISP-facing IP (<code>x.x.129.210</code>).</p><p>But no, it doesn’t work like this out of the box. And there was no way for me to explicitly configure the ISP gateway to route the <code>/29</code> DMZ subnet to a specific IP.</p><h2 id=the-solution-proxy-arp>The Solution: Proxy ARP&nbsp;<a class=yx-anchor href=#the-solution-proxy-arp><i class="las la-link"></i></a></h2><p>After lots of DuckDuckGoing (If searching with Google is called Googling, then that’s what searching with <a href=https://duckduckgo.com>DuckDuckGo</a> must be called, right?) to no avail, I finally stumbled over the <em>Virtual IP</em> settings in OPNsense, specifically of type <em>Proxy ARP</em>.</p><p>This Proxy ARP type of virtual IP allows you to broadcast the advertisement of IPs or subnets via an interface. So I entered:</p><ul><li>Mode: Proxy ARP</li><li>Interface: WAN</li><li>Address: <code>x.x.129.216/29</code></li></ul><figure><picture>
<source media="(min-width: 1200px)" srcset=https://res.cloudinary.com/ypertex/image/upload/ar_1.67,c_fill,dpr_auto,f_auto,g_auto,q_auto,w_1140//media/opnsense-virtual-ip-proxy-arp.png><source media="(min-width: 992px)" srcset=https://res.cloudinary.com/ypertex/image/upload/ar_1.67,c_fill,dpr_auto,f_auto,g_auto,q_auto,w_960//media/opnsense-virtual-ip-proxy-arp.png><source media="(min-width: 768px)" srcset=https://res.cloudinary.com/ypertex/image/upload/ar_1.67,c_fill,dpr_auto,f_auto,g_auto,q_auto,w_720//media/opnsense-virtual-ip-proxy-arp.png><source media="(min-width: 576px)" srcset=https://res.cloudinary.com/ypertex/image/upload/ar_1.67,c_fill,dpr_auto,f_auto,g_auto,q_auto,w_767//media/opnsense-virtual-ip-proxy-arp.png><img src=https://res.cloudinary.com/ypertex/image/upload/ar_1.67,c_fill,dpr_auto,f_auto,g_auto,q_auto,w_575//media/opnsense-virtual-ip-proxy-arp.png alt class="shadow img-fluid"></picture><figcaption class="mt-3 col-md-8 mx-auto">Setting Proxy ARP virtual IPs in OPNsense.</figcaption></figure><p>In other words: The OPNsense firewall router now published to the ISP gateway that (besides the IP <code>x.x.129.210</code>) it also was the recipient for all IP packets of the <code>/29</code> DMZ subnet. In a way, ARP allows to configure upstream routers that are not part of your own infrastructure.</p><p>This works like a charm. Servers in the DMZ configured with the public IPs of the second <code>/29</code> subnet are now able to communicate in both directions with the Internet.</p><hr><div class="alert mx-n3 p-3 alert-primary">OPNsense automatically adds the DMZ subnet to its NAT, so don’t forget to remove it manually. In this case, it was translating the public subnet <code>x.x.129.216/29</code> to the public IP <code>x.x.129.210</code>—which of course doesn’t make any sense whatsoever. It might work in the outbound direction, but your DMZ can’t be reached from the outside, rendering the DMZ useless.</div></div></div></section><section class="bg-light py-5"><div class=container><div class=row><div class="col-xl-8 col-lg-10 mx-auto"><div class="yx-heading mb-3">Share this article</div><div class="shadow card mx-n3"><div class=card-body><div class="row text-center"><div class=col><a class="btn btn-primary rounded-pill" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fblog.ypertex.com%2farticles%2fadvertise-subnet-with-opnsense-arp%2f&title=How%20to%20Advertise%20Subnets%20to%20Upstream%20Routers%20with%20OPNsense%20and%20ARP&source=Ypertex%20Blog" title=LinkedIn onclick="window.open(this.href,'linkedin-share','width=550,height=550');return false;"><i class="lab la-linkedin-in"></i>&nbsp;LinkedIn</a></div><div class=col><a class="btn btn-primary rounded-pill" href="https://twitter.com/intent/tweet?text=How%20to%20Advertise%20Subnets%20to%20Upstream%20Routers%20with%20OPNsense%20and%20ARP&url=https%3a%2f%2fblog.ypertex.com%2farticles%2fadvertise-subnet-with-opnsense-arp%2f" title=Twitter onclick="window.open(this.href,'twitter-share','width=550,height=550');return false;"><i class="lab la-twitter"></i>&nbsp;Twitter</a></div><div class=col><a class="btn btn-primary rounded-pill" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.ypertex.com%2farticles%2fadvertise-subnet-with-opnsense-arp%2f" title=Facebook onclick="window.open(this.href,'facebook-share','width=550,height=550');return false;"><i class="lab la-facebook-f"></i>&nbsp;Facebook</a></div></div></div></div></div></div></div></section><section class="container py-5"><div class=yx-heading>Recommended Articles</div><div class="row align-items-center"><div class="col-md-4 mb-3 mb-md-0 order-md-last"><a href=/articles/jumpcloud-curl-error-22/><picture>
<source media="(min-width: 1200px)" srcset=https://res.cloudinary.com/ypertex/image/upload/ar_1,c_fill,dpr_auto,f_auto,g_auto,q_auto,w_350/8a0f15ad-90b4-44b6-be9f-98261403072f><source media="(min-width: 992px)" srcset=https://res.cloudinary.com/ypertex/image/upload/ar_1,c_fill,dpr_auto,f_auto,g_auto,q_auto,w_290/8a0f15ad-90b4-44b6-be9f-98261403072f><source media="(min-width: 768px)" srcset=https://res.cloudinary.com/ypertex/image/upload/ar_0.75,c_fill,dpr_auto,f_auto,q_auto,w_210/8a0f15ad-90b4-44b6-be9f-98261403072f><source media="(min-width: 576px)" srcset=https://res.cloudinary.com/ypertex/image/upload/ar_2,c_fill,dpr_auto,f_auto,q_auto,w_510/8a0f15ad-90b4-44b6-be9f-98261403072f><img src=https://res.cloudinary.com/ypertex/image/upload/ar_2,c_fill,dpr_auto,f_auto,q_auto,w_545/8a0f15ad-90b4-44b6-be9f-98261403072f alt class="shadow w-100"></picture></a></div><div class="col-md-8 text-md-right"><p class="text-muted mb-2"><small><i class="las la-upload"></i>&nbsp;Jun 21, 2017 · <i class="las la-stopwatch"></i>&nbsp;4min read</small></p><div class=yx-stretched-linkable><h1>Working Around the JumpCloud Curl Error 22</h1><p>JumpCloud is a great tool to enable Single Sign On for whatever devices you have. Find out how to work around curl error 22 to keep using it on Linux. <a href=/articles/jumpcloud-curl-error-22/ class=stretched-link>Continue…</a></p></div><p class=mb-0><a href=/tags/tutorials/ class="badge badge-primary"><i class="las la-hashtag"></i>Tutorials</a></p></div></div></div></section></main><footer class="bg-secondary text-light text-center"><div class="container py-5"><p><small><a href=/privacy/>Privacy Policy</a></small></p><p><svg viewBox="0 0 440 176" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;max-height:1rem"><g transform="matrix(1,0,0,1,-2574,-792)"><g id="Unprotected-primary-color-logogram-on-transparent-background" serif:id="Unprotected primary color logogram on transparent background" transform="matrix(1.12719,0,0,0.885774,2612.5,797.543)"><rect x="-34.159" y="-6.258" width="390.352" height="198.696" style="fill:none"/><clipPath id="_clip1"><rect x="-34.159" y="-6.258" width="390.352" height="198.696"/></clipPath><g clip-path="url(#_clip1)"><g transform="matrix(3.69565,0,0,4.16217,-240.2,-272.956)"><g transform="matrix(0.105625,-6.62507e-18,5.86335e-18,0.119347,45.1899,52.1434)"><path d="M1e2 5e2 3e2 3e2 1e2 1e2h67.274C252.258 1e2 333.761 133.757 393.857 193.846 397.723 197.712 4e2 199.988 4e2 199.988L5e2 99.976 699.976 1e2 8e2 200.024 9e2 1e2h2e2L9e2 3e2l2e2 2e2H1032.74C947.747 5e2 866.238 466.238 806.141 406.141 802.276 402.276 8e2 4e2 8e2 4e2L7e2 5e2H5e2L7e2 3e2 6e2 200.024 3e2 5e2H1e2z" style="fill:#0af"/></g><g transform="matrix(0.105625,0,0,0.119347,45.1899,40.2116)"><path d="M5e2 599.976l4e2-4e2L7e2 199.953 3e2 599.976H5e2z" style="fill:#0e1112;fill-opacity:.2"/></g></g></g></g></g></svg></p><p><small>Copyright © 2017-2020 Michael Schmidle<br>Original content released under the <a href=http://creativecommons.org/licenses/by/4.0/>CC BY 4.0 International</a> license</small></p></div></footer><script src=https://code.jquery.com/jquery-3.4.1.slim.min.js integrity=sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n crossorigin=anonymous></script><script src=https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js integrity=sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6 crossorigin=anonymous></script></body></html>